---
title: "Geographical analysis of media"
subtitle: "3. Thematic tags"
author: "Claude Grasland"
output: html_notebook
---


```{r setup2, echo = FALSE, comment = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = FALSE, warning = FALSE)
library(knitr)
library(dplyr)
library(quanteda)
library(stringr)


```




# Thematic tags

The aim of this section is to add to the quanteda corpus different metadata related to "thematic" tags i.e. topics that can be considered as related to the same same types of events but *without considering space and time*. In other words a thematic tag should not be related to an isolated crisis or an isolated country but to something more general that could take place anytime and anywhere. As an example, the earthquake from Nepal in April 2015 is not a topic but an event which belongs to the general category of news about seismic risk. The Ebola outbreak from western Africa is different because it is not an isolated event but a group of events spreading through space and time. It can therefore be considered as a sub-topic of the more general topic of pandemics. Finally the so-called "migrant crisis" that occurred in Europe in 2015 is certainly a mega-event but it is probably not a good idea to choose it as a topic. It is more interesting in this case to look for all news associated to the topic of "human mobility accross borders" and to search for news speaking from migrant, refugges or asylum seekers in all countries and at all periods of time. The problem of topic's definition is therefore firstly a conceptual problem and only in a second step a question of keywords and dictionary. It the topic is not well defined, iy will not be possible to propose a consistent and coherent method of identification of news related to the topic. 

The thematic tags will be added to the corpus previously annotated by geographical units

```{r}
qd <-readRDS("data/corpus/qd_mycorpus_geo.RDS")
```



## Load tagging function

We can use exactly the same program of tagging than the one we have used previously for the tagging of geographical entities. The only condition is to prepare a dataframe with three columns

- lang : the language associated to the dictionary
- code : the tag to be used 
- label: the words or groups of words to be recognized 

```{r func_annotate}
extract_tags <- function(qd = qd,                      # the corpus of interest
                         lang = "fr",                  # the language to be used
                         dict = dict,                  # the dictionary of target 
                         code = "id" ,                  # variable used for coding
                         tagsname = "tags",                 # name of the tags column
                         split  = c("'","’","-"),       # split list
                         tolow = FALSE  ,                # Tokenize text
                         comps = c("Afrique du sud")  # compounds
                         )
{ 


  
# Tokenize  
x<-as.character(qd)


if(length(split) > 0) { reg<-paste(split, collapse = '|')
                       x <- gsub(reg," ",x)}  
if(tolow) { x <- tolower(x)} 
toks<-tokens(x)

# compounds
if(length(split) > 0) { reg<-paste(split, collapse = '|')
                       comps<- gsub(reg," ",comps)}  
if(tolow)       {comps <- tolower(comps)}  
toks<-tokens_compound(toks,pattern=phrase(comps))

  
# Load dictionaries and create compounds

  ## Target dictionary
dict<-dict[dict$lang==lang & is.na(dict$label)==F,]
target<-dict[ntoken(dict$label)>1,]
labels <-dict$label
if(length(split) > 0) { reg<-paste(split, collapse = '|')
                       labels<- gsub(reg," ",labels)}  
if(tolow)       {labels <- tolower(labels)}  
toks<-tokens_compound(toks,pattern=phrase(labels))
  
 # create quanteda dictionary
keys <-gsub(" ","_",labels)
qd_dict<-as.list(keys)
names(qd_dict)<-dict[[code]]
qd_dict<-dictionary(qd_dict,tolower = FALSE)

# Identify geo tags (states or reg or org ...)
toks_tags <- tokens_lookup(toks, qd_dict, case_insensitive = F)
toks_tags <- lapply(toks_tags, unique)
toks_tags<-as.tokens(toks_tags)
list_tags<-function(x){res<-paste(x, collapse=' ')}
docvars(qd)[[tagsname]]<-as.character(lapply(toks_tags,FUN=list_tags))
docvars(qd)[[paste("nb",tagsname,sep="")]]<-ntoken(toks_tags)



# Export results
return(qd)
 }
```


## The pandemic topic

### Dictionary

We decide here to use lower case transformation. We use a star for the words that can take a plural form.

```{r dico pandemic}
label <- c("épidémie*", "pandémie*", "virus", "oms", "ébola", "ebola",  "h1n1","sras", "chikungunya", "choléra", "peste")
code  <- rep("pand", length(label))
lang  <- rep("fr", length(label))
dict_pande <- data.frame(code,lang,label)
kable(dict_pande)

frcomps<-c("virus informatique")
```


### Annotation

```{r annotate pandemic, eval=FALSE}

qd <- extract_tags (qd = qd,
                     lang="fr",
                     dict = dict_pande,
                     code = "code",
                    tagsname = "pand",
                     split = c("'","’","-"),
                     comps = frcomps,
                     tolow = TRUE)

table(qd$nbpand)

```


### Visualization


```{r visualization pandemic}
x<-data.table(docvars(qd))
x$tag<-x$nbpand !=0
tab<-x[,.(tot=.N),by=.(month,tag, who)]
tab<-tab[tab$tag==TRUE,]
tab$month<-as.Date(tab$month)

       
       p<-ggplot(tab, aes(x=month,fill =who, y=tot))+
         geom_bar(stat="identity")+
         ggtitle(label ="Pandemic : distribution of tags by month and media",
                  subtitle = "1st Jan 2014 to 31th Dec.  2015")
p
```

## The quake topic

### Dictionary

We decide here to use lower case transformation. We use a star for the words that can take a plural form.

```{r dico quake}
label <- c("séisme*", "sismiqu*", "tremblement de terre", "tremblements de terre", "tsunami*", "USGS","échelle de Richter", "secousse tellurique")
code  <- rep("quak", length(label))
lang  <- rep("fr", length(label))
dict_quak <- data.frame(code,lang,label)
kable(dict_quak)

frcomps<-c("séisme politique")
```


### Annotation

```{r annotate quake, eval=FALSE}

qd <- extract_tags (qd = qd,
                     lang="fr",
                     dict = dict_quak,
                     code = "code",
                    tagsname = "quak",
                     split = c("'","’","-"),
                     comps = frcomps,
                     tolow = TRUE)

table(qd$nbquak)

```


### Visualization


```{r visualization quake}
x<-data.table(docvars(qd))
x$tag<-x$nbquak !=0
tab<-x[,.(tot=.N),by=.(month,tag, who)]
tab<-tab[tab$tag==TRUE,]
tab$month<-as.Date(tab$month)

       
       p<-ggplot(tab, aes(x=month,fill =who, y=tot))+
         geom_bar(stat="identity")+
         ggtitle(label ="Earthquakes : distribution of tags by month and media",
                  subtitle = "1st Jan 2014 to 31th Dec.  2015")
p
```


## The Migrant & Refugees topic

### Dictionary

In this last example, we introduce two subtopics corresponding to migrants and refugees or asylum seeker.The objective is to analyze a possibility of semantic shift. 

```{r dictionary mobil}
label <- c("migrant*", "émigrant*", "immigrant*", "migrat*", "réfugié*", "demandeur d'asile")
code  <- c("migr","migr","migr","migr", "refu","refu")
lang  <- rep("fr", length(label))
dict_mobil <- data.frame(code,lang,label)
kable(dict_mobil)

frcomps<-c("oiseaux migrateurs")
```


### Annotation

```{r annotate mobil, eval=FALSE}

qd <- extract_tags (qd = qd,
                     lang="fr",
                     dict = dict_mobil,
                     code = "code",
                    tagsname = "mobil",
                     split = c("'","’","-"),
                     comps = frcomps,
                     tolow = TRUE)

table(qd$mobil)

```


### Visualization


```{r visualization mobil}
x<-data.table(docvars(qd))
x$tag<-as.factor(x$mobil)
levels(x$tag)<-c(NA,"Migrants","Migrants & Refugies", "Refugiés","Migrants & Refugies" )
tab<-x[,.(tot=.N),by=.(month,tag)]
tab<-tab[is.na(tab$tag)==FALSE,]
tab$month<-as.Date(tab$month)

       
       p<-ggplot(tab, aes(x=month,fill =tag, y=tot))+
         geom_bar(stat="identity")+
         ggtitle(label ="Mobility : distribution of tags by month and qualification",
                  subtitle = "1st Jan 2014 to 31th Dec.  2015")
p
```
## Store results


We store the quanteda file which combine geographical and thematic tags :

```{r}
saveRDS(qd,"data/corpus/qd_mycorpus_geo_top.RDS")
paste("Size of resulting file = ",round(file.size("data/corpus/qd_mycorpus_geo_top.RDS")/1000000,3), "Mo")
```



